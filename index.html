<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS PRO MANAGER</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        dark: {
                            900: '#050505', // True Black background
                            800: '#121212', // Card background
                            700: '#1E1E1E', // Input background
                            600: '#2D2D2D', // Border
                        },
                        brand: {
                            light: '#2563eb', // Blue standard
                            dark: '#3b82f6', // Blue brighter
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Transizioni fluide ma secche professionali */
        body { transition: background-color 0.3s ease, color 0.3s ease; }
        
        /* Input styling */
        .input-field {
            transition: all 0.2s;
        }
        .input-field:focus {
            transform: translateY(-1px);
        }

        /* Scrollbar nascosta ma funzionale */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
    </style>
</head>
<body class="antialiased min-h-screen pb-40">
    
    <div id="app" :class="darkMode ? 'bg-dark-900 text-gray-200' : 'bg-gray-100 text-gray-900'" class="min-h-screen transition-colors duration-300">

        <header class="sticky top-0 z-40 backdrop-blur-md border-b" 
                :class="darkMode ? 'bg-dark-900/90 border-dark-600' : 'bg-white/90 border-gray-200'">
            <div class="max-w-7xl mx-auto p-4">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    
                    <div class="flex items-center gap-3 w-full md:w-auto justify-between">
                        <div>
                            <h1 class="text-2xl font-extrabold tracking-tight">NEXUS <span class="text-blue-500">PRO</span></h1>
                            <p class="text-[10px] uppercase tracking-widest opacity-60">Operations Manager</p>
                        </div>
                        <button @click="toggleTheme" class="md:hidden p-2 rounded-lg border" :class="darkMode ? 'border-gray-700 bg-dark-700' : 'border-gray-300 bg-gray-100'">
                            <i :class="darkMode ? 'ph-sun text-yellow-400' : 'ph-moon text-gray-600'" class="ph text-xl"></i>
                        </button>
                    </div>

                    <div class="flex flex-wrap justify-center gap-2 w-full md:w-auto">
                        <div class="flex rounded-lg overflow-hidden border" :class="darkMode ? 'border-gray-700' : 'border-gray-300'">
                            <button @click="backupData" class="px-3 py-2 text-xs font-bold hover:bg-blue-500 hover:text-white transition-colors" title="Scarica Backup">
                                <i class="ph ph-download-simple text-lg"></i>
                            </button>
                            <label class="px-3 py-2 text-xs font-bold hover:bg-blue-500 hover:text-white transition-colors cursor-pointer border-l" :class="darkMode ? 'border-gray-700' : 'border-gray-300'" title="Carica Backup">
                                <i class="ph ph-upload-simple text-lg"></i>
                                <input type="file" @change="restoreData" class="hidden" accept=".json">
                            </label>
                        </div>

                        <button @click="exportExcel" class="flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold border hover:bg-green-600 hover:text-white transition-colors" :class="darkMode ? 'border-green-800 text-green-400' : 'border-green-200 text-green-700 bg-green-50'">
                            <i class="ph ph-file-xls text-lg"></i> XLS
                        </button>
                        <button @click="exportPDF" class="flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold border hover:bg-red-600 hover:text-white transition-colors" :class="darkMode ? 'border-red-800 text-red-400' : 'border-red-200 text-red-700 bg-red-50'">
                            <i class="ph ph-file-pdf text-lg"></i> PDF
                        </button>
                        
                        <button @click="toggleTheme" class="hidden md:block ml-2 p-2 rounded-lg border transition-colors" :class="darkMode ? 'border-gray-700 bg-dark-700 hover:bg-dark-600' : 'border-gray-300 bg-white hover:bg-gray-100'">
                            <i :class="darkMode ? 'ph-sun text-yellow-400' : 'ph-moon text-gray-600'" class="ph text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                
                <div v-for="(row, index) in rows" :key="row.id" 
                     class="relative rounded-xl border shadow-lg overflow-hidden flex flex-col"
                     :class="darkMode ? 'bg-dark-800 border-dark-600' : 'bg-white border-gray-200'">
                    
                    <div class="flex justify-between items-center p-3 border-b" :class="darkMode ? 'bg-dark-700/50 border-dark-600' : 'bg-gray-50 border-gray-100'">
                        <span class="font-mono text-xs font-bold opacity-50">#{{ index + 1 }}</span>
                        <div class="flex gap-2">
                            <button @click="duplicateRow(row)" class="text-blue-400 hover:text-blue-500 p-1" title="Duplica"><i class="ph ph-copy"></i></button>
                            <button @click="removeRow(index)" class="text-red-400 hover:text-red-500 p-1" title="Elimina"><i class="ph ph-trash"></i></button>
                        </div>
                    </div>

                    <div class="p-4 space-y-3 flex-grow">
                        
                        <div class="grid grid-cols-1 gap-3">
                            <div class="relative group">
                                <label class="text-[10px] uppercase font-bold opacity-60 mb-1 block">Localit√†</label>
                                <div class="flex items-center border rounded-md overflow-hidden" :class="darkMode ? 'bg-dark-700 border-dark-600' : 'bg-gray-50 border-gray-300'">
                                    <input v-model="row.localita" class="w-full bg-transparent px-3 py-2 text-sm outline-none font-medium" placeholder="Citt√†...">
                                    <button @click="dictate(row, 'localita')" class="px-3 text-gray-400 hover:text-blue-500"><i class="ph ph-microphone"></i></button>
                                </div>
                            </div>
                            <div class="relative group">
                                <label class="text-[10px] uppercase font-bold opacity-60 mb-1 block">Indirizzo</label>
                                <div class="flex items-center border rounded-md overflow-hidden" :class="darkMode ? 'bg-dark-700 border-dark-600' : 'bg-gray-50 border-gray-300'">
                                    <input v-model="row.indirizzo" class="w-full bg-transparent px-3 py-2 text-sm outline-none" placeholder="Via/Piazza...">
                                    <button @click="dictate(row, 'indirizzo')" class="px-3 text-gray-400 hover:text-blue-500"><i class="ph ph-microphone"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] uppercase font-bold opacity-60 mb-1 block">POP/PFS</label>
                                <div class="flex items-center border rounded-md overflow-hidden" :class="darkMode ? 'bg-dark-700 border-dark-600' : 'bg-gray-50 border-gray-300'">
                                    <input v-model="row.pop_pfs" class="w-full bg-transparent px-2 py-2 text-sm outline-none" placeholder="COD...">
                                    <button @click="dictate(row, 'pop_pfs')" class="pr-2 text-gray-400 hover:text-blue-500"><i class="ph ph-microphone"></i></button>
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-bold opacity-60 mb-1 block">El. Ottico</label>
                                <div class="flex items-center border rounded-md overflow-hidden" :class="darkMode ? 'bg-dark-700 border-dark-600' : 'bg-gray-50 border-gray-300'">
                                    <input v-model="row.elemento_ottico" class="w-full bg-transparent px-2 py-2 text-sm outline-none" placeholder="Valore...">
                                    <button @click="dictate(row, 'elemento_ottico')" class="pr-2 text-gray-400 hover:text-blue-500"><i class="ph ph-microphone"></i></button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] uppercase font-bold opacity-60 mb-1 block">Permuta</label>
                            <div class="flex items-center border rounded-md overflow-hidden" :class="darkMode ? 'bg-dark-700 border-dark-600' : 'bg-gray-50 border-gray-300'">
                                <input v-model="row.permuta" class="w-full bg-transparent px-3 py-2 text-sm outline-none" placeholder="Dati permuta...">
                                <button @click="dictate(row, 'permuta')" class="px-3 text-gray-400 hover:text-blue-500"><i class="ph ph-microphone"></i></button>
                            </div>
                        </div>

                         <div>
                            <label class="text-[10px] uppercase font-bold opacity-60 mb-1 block">Note Extra</label>
                            <div class="flex items-center border rounded-md overflow-hidden" :class="darkMode ? 'bg-dark-700 border-dark-600' : 'bg-gray-50 border-gray-300'">
                                <textarea v-model="row.note" rows="1" class="w-full bg-transparent px-3 py-2 text-sm outline-none resize-none" placeholder="Scrivi note..."></textarea>
                                <button @click="dictate(row, 'note')" class="px-3 text-gray-400 hover:text-blue-500"><i class="ph ph-microphone"></i></button>
                            </div>
                        </div>

                        <div v-if="row.extras.length > 0" class="pt-2 border-t border-dashed space-y-2" :class="darkMode ? 'border-gray-700' : 'border-gray-300'">
                            <p class="text-[10px] font-bold text-blue-500">PARAMETRI AGGIUNTIVI</p>
                            <div v-for="(extra, eIdx) in row.extras" :key="eIdx" class="flex gap-2 items-center">
                                <input v-model="extra.key" class="w-1/3 bg-transparent text-xs font-bold border-b border-dashed outline-none py-1" :class="darkMode ? 'border-gray-600 text-blue-300' : 'border-gray-400 text-blue-700'" placeholder="Nome">
                                <input v-model="extra.value" class="w-full bg-transparent text-xs border-b border-dashed outline-none py-1" :class="darkMode ? 'border-gray-600' : 'border-gray-400'" placeholder="Valore">
                                <button @click="removeExtra(row, eIdx)" class="text-red-500 hover:text-red-400"><i class="ph ph-x"></i></button>
                            </div>
                        </div>

                    </div>

                    <button @click="addExtra(row)" class="w-full py-2 text-[10px] font-bold uppercase tracking-widest hover:bg-blue-500/10 transition-colors border-t"
                        :class="darkMode ? 'border-dark-600 text-gray-500 hover:text-blue-400' : 'border-gray-200 text-gray-500 hover:text-blue-600'">
                        + Aggiungi Parametro
                    </button>
                </div>

                <button @click="addRow" class="min-h-[300px] rounded-xl border-2 border-dashed flex flex-col items-center justify-center gap-4 transition-all opacity-60 hover:opacity-100 hover:scale-[1.02]"
                    :class="darkMode ? 'border-dark-600 hover:border-blue-500 hover:bg-dark-800' : 'border-gray-300 hover:border-blue-500 hover:bg-white'">
                    <i class="ph ph-plus-circle text-4xl text-blue-500"></i>
                    <span class="font-bold uppercase tracking-widest">Nuova Riga</span>
                </button>

            </div>
        </main>

        <div class="fixed bottom-0 left-0 right-0 z-50 p-4 border-t shadow-2xl" 
             :class="darkMode ? 'bg-dark-900 border-dark-600' : 'bg-white border-gray-200'">
            <div class="max-w-3xl mx-auto flex items-center justify-between gap-4">
                
                <button @click="exportWhatsapp" class="flex flex-col items-center gap-1 group">
                    <div class="p-3 rounded-full bg-green-500/10 text-green-500 group-hover:bg-green-500 group-hover:text-white transition-all">
                        <i class="ph ph-whatsapp-logo text-2xl"></i>
                    </div>
                    <span class="text-[9px] font-bold uppercase opacity-60">Invia</span>
                </button>

                <div class="relative -top-8">
                     <button @click="openMemory" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg border-4 transition-transform hover:scale-110 active:scale-95"
                        :class="darkMode ? 'bg-blue-600 border-dark-900 text-white shadow-blue-900/50' : 'bg-blue-600 border-white text-white shadow-blue-200'">
                        <i class="ph ph-brain text-3xl"></i>
                     </button>
                     <div class="text-center mt-2 text-[9px] font-bold uppercase opacity-60">Memoria</div>
                </div>

                <button @click="clearAll" class="flex flex-col items-center gap-1 group">
                    <div class="p-3 rounded-full bg-red-500/10 text-red-500 group-hover:bg-red-500 group-hover:text-white transition-all">
                        <i class="ph ph-trash text-2xl"></i>
                    </div>
                    <span class="text-[9px] font-bold uppercase opacity-60">Reset</span>
                </button>

            </div>
        </div>

        <div v-if="showMemory" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="w-full max-w-md rounded-xl p-6 shadow-2xl border" :class="darkMode ? 'bg-dark-800 border-dark-600' : 'bg-white border-gray-200'">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="ph ph-brain text-blue-500"></i> Memoria Vocale</h2>
                <div class="space-y-2 mb-4 max-h-60 overflow-y-auto">
                    <div v-for="(val, key) in dictationMemory" :key="key" class="flex justify-between items-center p-2 rounded border" :class="darkMode ? 'bg-dark-700 border-dark-600' : 'bg-gray-50 border-gray-200'">
                        <div>
                            <span class="text-red-400 text-xs line-through block">{{ key }}</span>
                            <span class="text-green-500 font-bold text-sm">{{ val }}</span>
                        </div>
                        <button @click="deleteMemoryRule(key)" class="text-gray-500 hover:text-red-500"><i class="ph ph-x"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <input v-model="newRule.wrong" placeholder="Se sente (es. 'tubo r')" class="p-2 text-sm rounded border bg-transparent" :class="darkMode ? 'border-gray-600' : 'border-gray-300'">
                    <input v-model="newRule.right" placeholder="Scrive (es. 'Tubo Rame')" class="p-2 text-sm rounded border bg-transparent" :class="darkMode ? 'border-gray-600' : 'border-gray-300'">
                </div>
                <button @click="addMemoryRule" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg">Salva Regola</button>
                <button @click="showMemory = false" class="w-full mt-2 text-sm opacity-60 hover:opacity-100">Chiudi</button>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    darkMode: true,
                    showMemory: false,
                    rows: [
                        { id: Date.now(), localita: '', indirizzo: '', pop_pfs: '', elemento_ottico: '', permuta: '', note: '', extras: [] }
                    ],
                    dictationMemory: JSON.parse(localStorage.getItem('nexus_memory')) || {
                        "tubo r k": "Tubo Rame (K)",
                        "fibra uno": "Fibra 1Gb",
                        "due per uno": "2x1"
                    },
                    newRule: { wrong: '', right: '' }
                }
            },
            mounted() {
                // Check localStorage for saved data
                const savedRows = localStorage.getItem('nexus_rows');
                if (savedRows) this.rows = JSON.parse(savedRows);
                
                // Theme check
                if (localStorage.getItem('nexus_theme') === 'light') this.darkMode = false;
            },
            watch: {
                rows: {
                    handler(newVal) {
                        localStorage.setItem('nexus_rows', JSON.stringify(newVal));
                    },
                    deep: true
                },
                darkMode(newVal) {
                    localStorage.setItem('nexus_theme', newVal ? 'dark' : 'light');
                }
            },
            methods: {
                toggleTheme() { this.darkMode = !this.darkMode; },
                
                // --- GESTIONE RIGHE ---
                addRow() {
                    this.rows.push({ 
                        id: Date.now(), 
                        localita: '', indirizzo: '', pop_pfs: '', 
                        elemento_ottico: '', permuta: '', note: '', extras: [] 
                    });
                },
                removeRow(index) {
                    if(confirm('Eliminare riga?')) this.rows.splice(index, 1);
                },
                duplicateRow(row) {
                    // Copia profonda per evitare riferimenti
                    const newRow = JSON.parse(JSON.stringify(row));
                    newRow.id = Date.now();
                    this.rows.push(newRow);
                },
                clearAll() {
                    if(confirm('Cancellare TUTTO?')) {
                        this.rows = [{ id: Date.now(), localita: '', indirizzo: '', pop_pfs: '', elemento_ottico: '', permuta: '', note: '', extras: [] }];
                    }
                },

                // --- EXTRAS ---
                addExtra(row) {
                    row.extras.push({ key: '', value: '' });
                },
                removeExtra(row, index) {
                    row.extras.splice(index, 1);
                },

                // --- MEMORIA & DETTATURA ---
                openMemory() { this.showMemory = true; },
                
                addMemoryRule() {
                    if(this.newRule.wrong && this.newRule.right) {
                        this.dictationMemory[this.newRule.wrong.toLowerCase()] = this.newRule.right;
                        localStorage.setItem('nexus_memory', JSON.stringify(this.dictationMemory));
                        this.newRule = { wrong: '', right: '' };
                    }
                },
                deleteMemoryRule(key) {
                    delete this.dictationMemory[key];
                    localStorage.setItem('nexus_memory', JSON.stringify(this.dictationMemory));
                },

                dictate(row, field) {
                    if (!('webkitSpeechRecognition' in window)) {
                        alert("Browser non supportato per dettatura");
                        return;
                    }
                    const recognition = new webkitSpeechRecognition();
                    recognition.lang = 'it-IT';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;

                    recognition.onresult = (event) => {
                        let text = event.results[0][0].transcript.toLowerCase();
                        
                        // Applica Memoria
                        for (const [wrong, right] of Object.entries(this.dictationMemory)) {
                            if (text.includes(wrong)) {
                                text = text.replace(new RegExp(wrong, 'g'), right);
                            }
                        }
                        
                        // Capitalize first letter logic base
                        if(text.length > 0) {
                            // Se il testo contiene sostituzioni speciali, lasciamo quelle, altrimenti capitalizza
                            // Semplificazione:
                            if(!Object.values(this.dictationMemory).some(v => text.includes(v))) {
                               text = text.charAt(0).toUpperCase() + text.slice(1);
                            }
                        }

                        row[field] = text;
                    };
                    recognition.start();
                },

                // --- EXPORT / IMPORT ---
                
                // 1. WhatsApp
                exportWhatsapp() {
                    let msg = "*REPORT NEXUS*\n\n";
                    this.rows.forEach((r, i) => {
                        if(r.indirizzo || r.pop_pfs) {
                            msg += `üìç *${r.localita} - ${r.indirizzo}*\n`;
                            msg += `üîå POP: ${r.pop_pfs} | üëÅ EL: ${r.elemento_ottico}\n`;
                            if(r.permuta) msg += `üîÑ Permuta: ${r.permuta}\n`;
                            if(r.note) msg += `üìù Note: ${r.note}\n`;
                            
                            if(r.extras.length > 0) {
                                r.extras.forEach(e => {
                                    if(e.key) msg += `üîπ ${e.key}: ${e.value}\n`;
                                });
                            }
                            msg += "_____________________\n";
                        }
                    });
                    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                },

                // 2. Excel
                exportExcel() {
                    const data = this.rows.map(r => {
                        // Base object
                        let obj = {
                            "Localit√†": r.localita,
                            "Indirizzo": r.indirizzo,
                            "POP/PFS": r.pop_pfs,
                            "El. Ottico": r.elemento_ottico,
                            "Permuta": r.permuta,
                            "Note": r.note
                        };
                        // Flatten Extras
                        r.extras.forEach(e => {
                            if(e.key) obj[`EXTRA: ${e.key}`] = e.value;
                        });
                        return obj;
                    });
                    
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Report");
                    XLSX.writeFile(wb, "Nexus_Report.xlsx");
                },

                // 3. PDF
                exportPDF() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    doc.text("NEXUS REPORT", 10, 10);
                    
                    const tableData = this.rows.map(r => {
                        let extraStr = r.extras.map(e => `${e.key}: ${e.value}`).join('\n');
                        return [r.localita, r.indirizzo, r.pop_pfs, r.elemento_ottico, r.permuta, r.note, extraStr];
                    });

                    doc.autoTable({
                        head: [['Localit√†', 'Indirizzo', 'POP', 'El. Ottico', 'Permuta', 'Note', 'Extra']],
                        body: tableData,
                        startY: 20,
                        styles: { fontSize: 8 },
                        theme: 'grid'
                    });

                    doc.save("Nexus_Report.pdf");
                },

                // 4. Backup & Restore (JSON)
                backupData() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.rows));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "nexus_backup_" + new Date().toISOString().slice(0,10) + ".json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                },
                restoreData(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            this.rows = JSON.parse(e.target.result);
                            alert("Backup ripristinato con successo!");
                        } catch (err) {
                            alert("Errore nel file di backup");
                        }
                    };
                    reader.readAsText(file);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
