<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapportino Tecnico v42</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">

    <style>
        body { background: #111827; font-family: 'Inter', sans-serif; }
        
        .a4-page {
            width: 210mm; height: 296mm; background: white; margin: 0 auto;
            padding: 8mm 10mm; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; position: relative; overflow: hidden; 
        }

        /* SMART CAPS SU TUTTI GLI INPUT */
        .r-input {
            width: 100%; background: transparent; border: none; outline: none;
            font-size: 11px; font-weight: 600; color: #111827; padding: 0; margin: 0;
            text-transform: capitalize; /* ECCO IL TRUCCO VISIVO */
        }
        .r-input::placeholder { color: #d1d5db; font-weight: 400; text-transform: none; }
        
        textarea.r-input { resize: none; overflow: hidden; min-height: 18px; line-height: 1.3; display: block; }

        .tech-box { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; padding: 6px 8px; margin-bottom: 6px; }
        .tech-label { font-family: 'JetBrains Mono', monospace; font-size: 8px; text-transform: uppercase; color: #6b7280; display: block; margin-bottom: 2px; }

        .tech-table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .tech-table th { text-align: left; font-family: 'JetBrains Mono', monospace; font-size: 8px; color: #6b7280; text-transform: uppercase; padding: 4px 0; border-bottom: 2px solid #111827; }
        .tech-table td { padding: 6px 4px; border-bottom: 1px solid #f3f4f6; vertical-align: top; }
        .tech-table tr:last-child td { border-bottom: none; }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* CLASSE STAMPA PDF - ANCHE QUI SMART CAPS */
        .print-text {
            font-size: 11px; font-weight: 600; color: #000; white-space: pre-wrap; line-height: 1.3;
            text-transform: capitalize; 
        }

        .signature-font { font-family: 'Dancing Script', cursive; font-size: 1.8rem; line-height: 1; }
        .header-bar { border-left: 4px solid #2563eb; padding-left: 10px; }

        @media print { .no-print { display: none !important; } body { background: white; margin: 0; } .a4-page { margin: 0; box-shadow: none; height: 100%; page-break-after: avoid; } }
        .screen-wrapper { padding: 40px 10px; display: flex; justify-content: center; overflow-x: auto; }
        @media (max-width: 800px) { .a4-page { min-width: 210mm; } .screen-wrapper { justify-content: flex-start; } }
    </style>
</head>
<body>

    <div id="app">
        <div class="fixed top-0 left-0 right-0 bg-[#0f172a] text-white px-4 py-2 flex justify-between items-center z-50 border-b border-gray-800 no-print">
            <div class="font-bold flex items-center gap-2 text-xs tracking-widest font-mono"><span class="text-blue-500">///</span> FIBER REPORT v42</div>
            <div class="flex gap-3 items-center overflow-x-auto">
                <button @click="importSmartData" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded text-[10px] uppercase tracking-wide whitespace-nowrap">Importa Dati</button>
                <a href="index.html" class="px-3 py-1 border border-gray-600 text-gray-300 hover:text-white rounded text-[10px] uppercase tracking-wide whitespace-nowrap">Indietro</a>
                <div class="flex gap-1">
                    <button @click="downloadFiberPDF" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded text-[10px] uppercase whitespace-nowrap">XLS</button>
                    <button @click="downloadRapportinoPDF" class="px-4 py-1 bg-white text-black hover:bg-gray-200 font-bold rounded text-[10px] uppercase flex items-center gap-2 whitespace-nowrap"><i class="ph ph-file-pdf"></i> PDF A4</button>
                </div>
            </div>
        </div>

        <div class="h-12 no-print"></div>

        <div class="screen-wrapper">
            <div class="a4-page" id="pdf-content">
                <div class="flex-grow">
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-1/3">
                            <div class="relative group cursor-pointer" @click="triggerLogoUpload">
                                <div class="h-16 w-full flex items-center justify-start">
                                    <img v-if="logoSrc" :src="logoSrc" class="h-full w-auto object-contain object-left">
                                    <div v-else class="w-32 h-10 bg-gray-100 border border-dashed border-gray-300 flex items-center justify-center text-gray-400 text-[9px] mono">LOGO</div>
                                </div>
                                <input type="file" ref="logoInput" @change="handleLogo" class="hidden" accept="image/*">
                            </div>
                        </div>
                        <div class="text-right header-bar">
                            <h1 class="text-2xl font-black text-gray-900 uppercase tracking-tighter leading-none">Rapporto Giornaliero</h1>
                            <div class="text-[10px] text-gray-500 font-mono mt-1">REF: INTERVENTO TECNICO</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-12 gap-2 mb-4">
                        <div class="col-span-3 tech-box"><span class="tech-label">DATA INTERVENTO</span><input v-model="displayDate" class="r-input mono text-sm"></div>
                        <div class="col-span-3 tech-box"><span class="tech-label">CLIENTE</span><input v-model="cliente" class="r-input text-sm" placeholder="Es. Open Fiber"></div>
                        <div class="col-span-6 tech-box"><span class="tech-label">ASSISTENTE DI RIFERIMENTO</span><input v-model="assistente" class="r-input text-sm" placeholder="Nome Cognome"></div>
                    </div>

                    <div class="tech-box mb-6"><span class="tech-label">LOCALITÀ / CANTIERI</span><input v-model="localita" class="r-input uppercase" placeholder="INSERIRE COMUNI..."></div>

                    <div class="mb-6">
                        <div class="flex justify-between items-end border-b border-gray-300 mb-2 pb-1"><span class="text-[10px] font-bold uppercase tracking-widest text-gray-900">01. Squadra Operativa</span><button @click="addWorker" class="text-[9px] text-blue-600 font-bold no-print">+ ADD</button></div>
                        <div class="bg-gray-50 border border-gray-200 rounded p-2">
                            <table class="tech-table">
                                <thead><tr><th class="w-24">RUOLO</th><th>TECNICO</th><th class="w-10 text-center">ORD</th><th class="w-10 text-center">STR</th><th class="w-10 text-center">VIG</th><th class="w-24">NOTE</th><th class="w-4 no-print"></th></tr></thead>
                                <tbody>
                                    <tr v-for="(worker, idx) in workers" :key="idx">
                                        <td><select v-model="worker.role" class="bg-transparent font-bold text-[10px] text-gray-900 w-full outline-none"><option value="CS">CAPOSQUADRA</option><option value="OP">TECNICO</option><option value="GI">GIUNTISTA</option><option value="IM">IMPIANTISTA</option><option value="PC">POSACAVI</option><option value="DIP">DIPENDENTE</option></select></td>
                                        <td><input v-model="worker.name" class="r-input" placeholder="..."></td><td class="text-center"><input type="number" v-model="worker.h_ord" class="r-input text-center mono"></td><td class="text-center"><input type="number" v-model="worker.h_str" class="r-input text-center mono"></td><td class="text-center"><input type="number" v-model="worker.h_vg" class="r-input text-center mono"></td><td><input v-model="worker.notes" class="r-input" placeholder="-"></td><td class="text-center no-print"><button @click="workers.splice(idx, 1)" class="text-red-400">×</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between items-end border-b border-gray-300 mb-2 pb-1"><span class="text-[10px] font-bold uppercase tracking-widest text-gray-900">02. Dettaglio Lavorazioni</span><div class="flex gap-2 no-print"><button @click="importSmartData" class="text-[9px] text-blue-600 font-bold">AGGIORNA</button><button @click="addWork" class="text-[9px] text-green-600 font-bold">+ RIGA</button></div></div>
                        <table class="tech-table">
                            <thead><tr><th class="w-8">N.</th><th class="w-1/3">INDIRIZZO (LOCALITÀ)</th><th>DESCRIZIONE / NOTE TECNICHE</th><th class="w-10 text-center">Q.TÀ</th><th class="w-4 no-print"></th></tr></thead>
                            <tbody>
                                <tr v-for="(work, idx) in works" :key="idx">
                                    <td class="font-bold text-gray-400 mono">{{ idx + 1 }}</td>
                                    <td class="pr-3"><textarea v-model="work.address" rows="1" class="r-input font-bold uppercase" placeholder="VIA..." oninput="this.style.height='';this.style.height=this.scrollHeight+'px'"></textarea></td>
                                    <td class="pr-3"><textarea v-model="work.desc" rows="1" class="r-input text-gray-700" placeholder="Dettagli..." oninput="this.style.height='';this.style.height=this.scrollHeight+'px'"></textarea></td>
                                    <td class="text-center"><input type="number" v-model="work.qty" class="r-input text-center font-bold mono"></td>
                                    <td class="text-center no-print"><button @click="works.splice(idx, 1)" class="text-red-400">×</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-auto border-t-2 border-gray-900 pt-4">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex gap-4">
                            <div class="tech-box w-32"><span class="tech-label">MEZZO</span><input v-model="mezzo" class="r-input" placeholder="Modello"></div>
                            <div class="tech-box w-24"><span class="tech-label">TARGA</span><input v-model="targa" class="r-input uppercase mono" placeholder="TARGA"></div>
                            <div class="tech-box w-20"><span class="tech-label">KM</span><input type="number" v-model="km" class="r-input mono text-right" placeholder="0"></div>
                        </div>
                        <div class="flex flex-col items-end">
                            <label class="flex items-center gap-2 cursor-pointer no-print mb-1"><span class="tech-label text-blue-600">RIFORNIMENTO</span><input type="checkbox" v-model="showFuel" class="accent-black"></label>
                            <div v-if="showFuel" class="flex gap-2"><div class="tech-box w-16"><span class="tech-label">LITRI</span><input v-model="fuelLitres" class="r-input text-center mono"></div><div class="tech-box w-16"><span class="tech-label">EURO</span><input v-model="fuelEuro" class="r-input text-center mono"></div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-10">
                        <div class="border border-gray-300 rounded flex text-center bg-gray-50 h-16"><div class="flex-1 border-r border-gray-300 p-1 flex flex-col justify-between"><span class="tech-label">VISTO ASSISTENTE</span></div><div class="flex-1 border-r border-gray-300 p-1 flex flex-col justify-between"><span class="tech-label">VISTO AMMIN.</span></div><div class="flex-1 p-1 flex flex-col justify-between"><span class="tech-label">VISTO CONTAB.</span></div></div>
                        <div class="relative border-b border-gray-900 h-16 flex items-end justify-center"><span class="tech-label absolute top-0 left-0">FIRMA CAPOSQUADRA</span><input v-model="signatureName" class="absolute inset-0 opacity-0 cursor-text z-10 w-full h-full text-center" placeholder="Firma"><span v-if="!signatureName" class="text-gray-300 text-xs mb-2 no-print select-none">Clicca per firmare</span><span v-else class="signature-font mb-1">{{ signatureName }}</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    logoSrc: localStorage.getItem('delta_logo') || '',
                    dataOggi: new Date().toISOString().split('T')[0],
                    displayDate: new Date().toLocaleDateString('it-IT'),
                    cliente: 'Open Fiber', localita: '', assistente: '', 
                    workers: [{ role: 'CS', name: '', h_ord: 8, h_str: '', h_vg: '', notes: '' }, { role: 'DIP', name: '', h_ord: 8, h_str: '', h_vg: '', notes: '' }],
                    works: [ { address: '', desc: '', qty: '' } ],
                    mezzo: '', targa: '', km: '', showFuel: false, fuelLitres: '', fuelEuro: '', signatureName: ''
                }
            },
            methods: {
                triggerLogoUpload() { this.$refs.logoInput.click(); },
                handleLogo(event) { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { this.logoSrc = e.target.result; localStorage.setItem('delta_logo', this.logoSrc); }; reader.readAsDataURL(file); } },
                addWorker() { this.workers.push({ role: 'OP', name: '', h_ord: 8, h_str: '', h_vg: '', notes: '' }); },
                addWork() { this.works.push({ address: '', desc: '', qty: '' }); },
                
                // FUNZIONE SMART CAPS PER EXPORT (Mantiene Maiuscolo se già tutto maiuscolo)
                smartFormat(text) {
                    if (!text) return '';
                    return text.replace(/\S+/g, (word) => {
                        if (word === word.toUpperCase() && word.length > 1) return word;
                        return word.charAt(0).toUpperCase() + word.slice(1);
                    });
                },

                importSmartData() {
                    const savedSheets = localStorage.getItem('fiber_sheets');
                    if (!savedSheets) { alert("Nessun dato!"); return; }
                    const sheets = JSON.parse(savedSheets);
                    let targetSheet = sheets.find(s => s.date === this.dataOggi) || sheets[sheets.length - 1]; 
                    if(targetSheet.team) {
                        let splitNames = targetSheet.team.split(/\s*[-/]\s*/);
                        if(splitNames[0]) this.workers[0].name = splitNames[0];
                        if(splitNames[1] && this.workers[1]) this.workers[1].name = splitNames[1];
                    }
                    let uniqueCities = new Set();
                    this.works = []; 
                    targetSheet.rows.forEach(r => {
                        if(r.localita) uniqueCities.add(r.localita.toUpperCase());
                        let fullAddress = r.indirizzo || "";
                        if(r.localita && fullAddress) fullAddress += ` (${r.localita})`;
                        else if(!fullAddress && r.localita) fullAddress = r.localita;
                        let finalDesc = r.note || "";
                        let lowerNote = finalDesc.toLowerCase();
                        if(r.permuta) {
                            if(!finalDesc.trim()) finalDesc = `Guasto Risolto - Permuta: ${r.permuta}`;
                            else finalDesc += ` - Permuta: ${r.permuta}`;
                        }
                        if(lowerNote.includes("giunzion") && r.elemento_ottico) {
                            let words = lowerNote.split(/\s+/);
                            let idx = words.findIndex(w => w.includes("giunzion"));
                            let nextWords = "";
                            if(idx !== -1 && idx < words.length - 1) nextWords = words.slice(idx + 1, idx + 4).join(" ");
                            const skipKeywords = ["pta", "pte", "roe", "pd", "pfs", "pfp"];
                            if(!skipKeywords.some(k => nextWords.includes(k))) finalDesc += ` - Elemento: ${r.elemento_ottico}`;
                        }
                        if(fullAddress || finalDesc) {
                            this.works.push({ address: fullAddress.toUpperCase(), desc: finalDesc, qty: '1' });
                        }
                    });
                    this.localita = Array.from(uniqueCities).join(', ');
                    this.displayDate = new Date().toLocaleDateString('it-IT');
                    alert("Dati Importati!");
                },

                async downloadRapportinoPDF() {
                    const element = document.getElementById('pdf-content');
                    window.scrollTo(0,0);
                    let dateFilename = this.displayDate.replace(/\//g, '-'); 

                    const inputs = element.querySelectorAll('input, textarea, select');
                    const originalStates = [];
                    const btns = document.querySelectorAll('.no-print');
                    btns.forEach(b => b.style.opacity = '0');

                    inputs.forEach((input) => {
                        originalStates.push({ element: input, display: input.style.display });
                        const textDiv = document.createElement('div');
                        
                        if (input.tagName === 'SELECT') {
                            textDiv.innerText = input.options[input.selectedIndex].text;
                        } else {
                            textDiv.innerText = input.value;
                        }

                        if(input.type === 'checkbox') return;

                        textDiv.className = input.className + ' print-text';
                        if(input.tagName === 'TEXTAREA') textDiv.style.minHeight = Math.max(18, input.scrollHeight) + 'px';
                        
                        input.style.display = 'none';
                        input.parentNode.insertBefore(textDiv, input);
                    });

                    const opt = { margin: 0, filename: `Rapportino_${dateFilename}.pdf`, image: { type: 'jpeg', quality: 0.99 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: 'avoid-all' }};
                    await html2pdf().set(opt).from(element).save();

                    setTimeout(() => {
                        document.querySelectorAll('.print-text').forEach(el => el.remove());
                        inputs.forEach((input, i) => input.style.display = originalStates[i].display);
                        btns.forEach(b => b.style.opacity = '1');
                    }, 500);
                },

                downloadFiberPDF() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const savedSheets = localStorage.getItem('fiber_sheets');
                    if (!savedSheets) return alert("Nessun dato.");
                    const sheets = JSON.parse(savedSheets);
                    let targetSheet = sheets.find(s => s.date === this.dataOggi) || sheets[sheets.length - 1];
                    let parts = targetSheet.date.split('-');
                    let dateIT = `${parts[2]}/${parts[1]}/${parts[0]}`;
                    let dateFile = `${parts[2]}-${parts[1]}-${parts[0]}`;

                    doc.setFillColor(15, 23, 42); 
                    doc.rect(0, 0, 210, 20, 'F');
                    doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.setFont('helvetica', 'bold'); doc.text("FIBER REPORT", 10, 13);
                    doc.setFontSize(10); doc.text(`SQUADRA: ${this.smartFormat(targetSheet.team)}`, 130, 9);
                    doc.text(`DATA: ${dateIT}`, 130, 15);

                    const body = targetSheet.rows.map(r => {
                        let matStr = r.materiale_list ? r.materiale_list.map(m => `• ${this.smartFormat(m.text)}`).join("\n") : "";
                        return [this.smartFormat(r.localita), this.smartFormat(r.indirizzo), this.smartFormat(r.pop_pfs), this.smartFormat(r.elemento_ottico), this.smartFormat(r.permuta), r.stato ? r.stato.replace(/_/g, ' ') : '', this.smartFormat(r.note), matStr];
                    });

                    doc.autoTable({
                        head: [['LOC.', 'INDIRIZZO', 'NODO', 'OTTICO', 'PERMUTA', 'STATO', 'NOTE', 'MATERIALE']],
                        body: body, startY: 25, theme: 'grid',
                        headStyles: { fillColor: [15, 23, 42], textColor: 255, fontStyle: 'bold', fontSize: 8 },
                        styles: { fontSize: 7, cellPadding: 2, valign: 'middle' }, 
                        columnStyles: { 0: { cellWidth: 20 }, 1: { cellWidth: 35 }, 6: { cellWidth: 35 }, 7: { cellWidth: 30 } },
                        didParseCell: function(data) {
                            if (data.section === 'body') {
                                let st = data.row.raw[5];
                                if (st === 'DA_SBLOCCARE') data.cell.styles.fillColor = [220, 252, 231];
                                if (st === 'OCCORRE_ASSISTENTE') data.cell.styles.fillColor = [254, 249, 195];
                                if (st === 'NEGATO_ACCESSO') data.cell.styles.fillColor = [254, 226, 226];
                                if (st === 'NON_REALIZZATO') data.cell.styles.fillColor = [254, 202, 202];
                                if (st === 'OCCORRE_MATERIALE') data.cell.styles.fillColor = [255, 237, 213];
                            }
                        }
                    });
                    doc.save(`FiberReport_${dateFile}.pdf`);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
