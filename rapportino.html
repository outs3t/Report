<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapportino Delta Impianti</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        body { background: #525659; font-family: 'Roboto', sans-serif; }
        
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 20px auto;
            padding: 15mm;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        .r-input {
            border: none;
            border-bottom: 1px dotted #ccc;
            width: 100%;
            padding: 2px;
            outline: none;
            font-size: 14px;
            transition: border 0.3s;
        }
        .r-input:focus { border-bottom: 1px solid #00468b; background: #f0f8ff; }

        .signature-font {
            font-family: 'Great Vibes', cursive;
            font-size: 2.5rem;
            color: #00468b;
            line-height: 1;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; margin: 0; }
            .a4-page { box-shadow: none; margin: 0; }
        }
        
        /* Animazione per il tasto Importa */
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .btn-smart { animation: pulse-blue 2s infinite; }
    </style>
</head>
<body>

    <div id="app">
        
        <div class="fixed top-0 left-0 right-0 bg-gray-900 text-white p-3 flex justify-between items-center z-50 shadow-lg no-print">
            <div class="font-bold flex items-center gap-2">
                <i class="ph ph-file-text text-yellow-400"></i> EDITOR RAPPORTINO
            </div>
            <div class="flex gap-3">
                <button @click="importSmartData" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded shadow-lg flex items-center gap-2 btn-smart border border-blue-400">
                    <i class="ph ph-magic-wand text-xl"></i> IMPORTA DA FIBER
                </button>

                <div class="w-px h-8 bg-gray-700 mx-2"></div>

                <a href="index.html" class="px-4 py-2 text-xs font-bold text-gray-300 hover:text-white border border-gray-600 rounded flex items-center">INDIETRO</a>
                <button @click="downloadPDF" class="px-6 py-2 bg-yellow-500 hover:bg-yellow-400 text-black font-bold rounded shadow-lg flex items-center gap-2">
                    <i class="ph ph-download-simple"></i> PDF
                </button>
            </div>
        </div>

        <div class="a4-page" id="pdf-content">
            
            <div class="flex justify-between items-start mb-8 border-b-2 border-[#003366] pb-4">
                <div class="w-1/3">
                    <div class="relative group cursor-pointer" @click="triggerLogoUpload">
                        <img v-if="logoSrc" :src="logoSrc" class="max-h-24 object-contain">
                        <div v-else class="h-24 w-40 bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 text-xs text-center p-2">
                            Clicca qui per<br>caricare Logo
                        </div>
                        <input type="file" ref="logoInput" @change="handleLogo" class="hidden" accept="image/*">
                    </div>
                </div>

                <div class="w-2/3 text-right">
                    <h1 class="text-3xl font-black text-[#003366] uppercase tracking-tighter">Rapportino Giornaliero</h1>
                    <div class="mt-2 flex justify-end items-center gap-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Data:</label>
                        <input type="date" v-model="dataOggi" class="text-right font-bold text-lg outline-none border-b border-gray-300 w-40">
                    </div>
                    <div class="mt-1 flex justify-end items-center gap-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Cliente:</label>
                        <input v-model="cliente" class="text-right font-bold outline-none border-b border-gray-300 w-48" placeholder="Es. Open Fiber">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-8 mb-6">
                <div>
                    <label class="block text-xs font-bold text-[#003366] uppercase mb-1">Località / Cantiere</label>
                    <input v-model="localita" class="r-input font-bold text-lg" placeholder="Es. Grumo Nevano">
                </div>
                <div>
                    <label class="block text-xs font-bold text-[#003366] uppercase mb-1">Assistente / Riferimento</label>
                    <input v-model="assistente" class="r-input font-bold" placeholder="Es. Sergio Benaglio">
                </div>
            </div>

            <div class="mb-8">
                <div class="bg-[#003366] text-white px-2 py-1 text-xs font-bold uppercase tracking-widest mb-2 flex justify-between items-center">
                    <span>Squadra Operativa</span>
                    <button @click="addWorker" class="text-yellow-400 hover:text-white text-[10px] no-print">+ AGGIUNGI</button>
                </div>
                
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-left text-gray-500 text-[10px] uppercase border-b">
                            <th class="pb-1 w-1/12">Ruolo</th>
                            <th class="pb-1 w-5/12">Nome e Cognome</th>
                            <th class="pb-1 w-2/12 text-center">Ore Ord.</th>
                            <th class="pb-1 w-2/12 text-center">Ore Str.</th>
                            <th class="pb-1 w-2/12 text-center">Note</th>
                            <th class="pb-1 w-10 no-print"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(worker, idx) in workers" :key="idx" class="border-b border-gray-100">
                            <td class="py-2">
                                <select v-model="worker.role" class="outline-none bg-transparent font-bold text-[#003366]">
                                    <option value="CS">Caposquadra</option>
                                    <option value="OP">Tecnico</option>
                                </select>
                            </td>
                            <td class="py-2"><input v-model="worker.name" class="r-input" placeholder="Nome..."></td>
                            <td class="py-2 text-center"><input type="number" v-model="worker.h_ord" class="r-input text-center w-12"></td>
                            <td class="py-2 text-center"><input type="number" v-model="worker.h_str" class="r-input text-center w-12"></td>
                            <td class="py-2"><input v-model="worker.notes" class="r-input text-xs" placeholder="-"></td>
                            <td class="py-2 text-center no-print">
                                <button @click="workers.splice(idx, 1)" class="text-red-400 hover:text-red-600">×</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mb-8">
                <div class="bg-[#ff9900] text-white px-2 py-1 text-xs font-bold uppercase tracking-widest mb-2 flex justify-between items-center">
                    <span>Descrizione Attività & Materiali</span>
                    <div class="no-print flex gap-2">
                        <button @click="importSmartData" class="text-blue-800 hover:text-white text-[10px] font-bold bg-white/20 px-2 rounded">AGGIORNA DATI</button>
                        <button @click="addWork" class="text-white hover:text-black text-[10px]">+ RIGA</button>
                    </div>
                </div>

                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-left text-gray-500 text-[10px] uppercase border-b">
                            <th class="pb-1 w-10">N.</th>
                            <th class="pb-1">Descrizione Lavoro / Materiale Utilizzato</th>
                            <th class="pb-1 w-20 text-center">U.M.</th>
                            <th class="pb-1 w-20 text-center">Q.tà</th>
                            <th class="pb-1 w-10 no-print"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(work, idx) in works" :key="idx" class="border-b border-gray-100 align-top">
                            <td class="py-2 font-bold text-gray-400">{{ idx + 1 }}</td>
                            <td class="py-2">
                                <textarea v-model="work.desc" rows="1" class="r-input resize-none overflow-hidden" 
                                          :class="{'font-bold text-[#003366]': work.isMaterial}"
                                          placeholder="Descrizione..." 
                                          oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                            </td>
                            <td class="py-2 text-center"><input v-model="work.um" class="r-input text-center"></td>
                            <td class="py-2 text-center"><input type="number" v-model="work.qty" class="r-input text-center font-bold"></td>
                            <td class="py-2 text-center no-print">
                                <button @click="works.splice(idx, 1)" class="text-red-400 hover:text-red-600">×</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="absolute bottom-10 left-10 right-10">
                <div class="border-t-2 border-gray-200 pt-4 mb-8">
                    <div class="grid grid-cols-4 gap-4 text-sm">
                        <div class="col-span-2">
                            <label class="text-[10px] text-gray-500 uppercase font-bold">Mezzo</label>
                            <div class="flex gap-2">
                                <input v-model="mezzo" class="r-input" placeholder="Modello">
                                <input v-model="targa" class="r-input w-24 uppercase" placeholder="Targa">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase font-bold">KM</label>
                            <input type="number" v-model="km" class="r-input" placeholder="0">
                        </div>
                        <div class="relative">
                            <label class="text-[10px] text-gray-500 uppercase font-bold flex items-center gap-2">
                                Rifornimento <input type="checkbox" v-model="showFuel" class="no-print">
                            </label>
                            <div v-if="showFuel" class="flex gap-2 mt-1">
                                <input v-model="fuelLitres" class="r-input" placeholder="Litri">
                                <input v-model="fuelEuro" class="r-input" placeholder="€">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-20">
                    <div>
                        <div class="text-[10px] text-gray-500 uppercase font-bold mb-8">Visto Assistente</div>
                        <div class="border-b border-gray-300 h-8"></div>
                    </div>
                    <div>
                        <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Firma Caposquadra</div>
                        <input v-model="signatureName" class="w-full text-center outline-none border-none text-gray-400 text-xs no-print mb-1" placeholder="Scrivi nome...">
                        <div class="h-16 flex items-end justify-center border-b border-gray-300 relative">
                            <span v-if="signatureName" class="signature-font absolute bottom-2 transform -rotate-2">{{ signatureName }}</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    logoSrc: localStorage.getItem('delta_logo') || '',
                    dataOggi: new Date().toISOString().split('T')[0],
                    cliente: 'Open Fiber',
                    localita: '',
                    assistente: 'Sergio Benaglio',
                    workers: [
                        { role: 'CS', name: '', h_ord: 8, h_str: '', notes: '' },
                        { role: 'OP', name: '', h_ord: 8, h_str: '', notes: '' }
                    ],
                    works: [ { desc: '', um: '', qty: '', isMaterial: false } ],
                    mezzo: 'Fiat Fiorino', targa: '', km: '', showFuel: false, fuelLitres: '', fuelEuro: '', signatureName: ''
                }
            },
            methods: {
                triggerLogoUpload() { this.$refs.logoInput.click(); },
                handleLogo(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => { this.logoSrc = e.target.result; localStorage.setItem('delta_logo', this.logoSrc); };
                        reader.readAsDataURL(file);
                    }
                },
                addWorker() { this.workers.push({ role: 'OP', name: '', h_ord: 8, h_str: '', notes: '' }); },
                addWork() { this.works.push({ desc: '', um: '', qty: '', isMaterial: false }); },
                
                // --- IL CERVELLO: IMPORTAZIONE INTELLIGENTE ---
                importSmartData() {
                    const savedSheets = localStorage.getItem('fiber_sheets');
                    if (!savedSheets) { alert("Nessun dato trovato in Fiber Report!"); return; }
                    
                    const sheets = JSON.parse(savedSheets);
                    // Cerca il foglio con la data di oggi, altrimenti l'ultimo modificato
                    let targetSheet = sheets.find(s => s.date === new Date().toLocaleDateString('it-IT'));
                    if (!targetSheet) targetSheet = sheets[sheets.length - 1]; // Fallback all'ultimo

                    if (!targetSheet) { alert("Nessun foglio trovato."); return; }

                    // 1. Aggiorna Intestazione
                    if(targetSheet.team) this.workers[0].name = targetSheet.team + " (Caposquadra)"; // Mette il nome squadra come CS provvisorio
                    
                    // 2. Analisi Dati per Riassunto
                    let locations = new Set();
                    let pops = new Set();
                    let materials = [];
                    let notes = [];

                    targetSheet.rows.forEach(r => {
                        if(r.localita) locations.add(r.localita);
                        if(r.pop_pfs) pops.add(r.pop_pfs);
                        if(r.note) notes.push(r.note);
                        
                        // Raccogli materiali
                        r.materiale_list.forEach(m => {
                            materials.push(m.text);
                        });
                    });

                    // 3. Costruzione Righe Intelligenti
                    this.works = []; // Resetta righe

                    // RIGA 1: Luoghi e Attività Generale
                    let locString = Array.from(locations).join(', ');
                    let popString = Array.from(pops).join(', ');
                    
                    let descAttivita = `Intervento tecnico eseguito presso: ${locString}. `;
                    if(popString) descAttivita += `Lavorazioni su nodi ottici: ${popString}. `;
                    descAttivita += "Verifica, installazione e collaudo elementi di rete.";
                    
                    this.works.push({ desc: descAttivita, um: 'A corpo', qty: '1', isMaterial: false });

                    // RIGA 2: MATERIALE (Aggregato per scarico magazzino)
                    if (materials.length > 0) {
                        // Rimuovi duplicati semplici o lasciali tutti se servono le quantità (qui facciamo lista unica)
                        let uniqueMaterials = [...new Set(materials)]; 
                        let matString = uniqueMaterials.join(" - ");
                        
                        this.works.push({ 
                            desc: `MATERIALE UTILIZZATO PER PRODUZIONE: ${matString}`, 
                            um: '', 
                            qty: '', 
                            isMaterial: true // Questo lo renderà in grassetto blu
                        });
                    } else {
                        this.works.push({ desc: "Nessun materiale di consumo rilevato.", um: '', qty: '', isMaterial: true });
                    }

                    // RIGA 3: Note Importanti (se ci sono)
                    if (notes.length > 0) {
                        this.works.push({ desc: `NOTE OPERATIVE: ${notes.join('. ')}`, um: '', qty: '', isMaterial: false });
                    }

                    // Aggiorna località nel campo in alto
                    this.localita = locString;
                    
                    alert("Dati importati con successo dal Fiber Report!");
                },

                downloadPDF() {
                    const element = document.getElementById('pdf-content');
                    const opt = {
                        margin: 0, filename: `Rapportino_${this.localita}_${this.dataOggi}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };
                    html2pdf().set(opt).from(element).save();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>